# MaxQuant proteomics analysis on UCSF Wynton HPC
Contact: Biafra Ahanonu (https://profiles.ucsf.edu/biafra.ahanonu).

## Overview

This repository-directory contains code, example MaxQuant XML files, and instructions to get MaxQuant working on Wynton.

The end goal is to have python or R wrapper scripts to enable changing of key MaxQuant values in XML files without having to edit the XML files directly or use the GUI. This would include automatically filling out the files to be analyzed (`filePaths`) and experiment names (`experiments`) from a folder containing `.RAW`, `.d`, etc. outputs from MS machines.

## MaxQuant references

MaxQuant: https://www.maxquant.org/
MaxQuant Bioconda: https://bioconda.github.io/recipes/maxquant/README.html
MaxQuant papers:
- https://pubmed.ncbi.nlm.nih.gov/19373234/ - Cox, J., Matic, I., Hilger, M., Nagaraj, N., Selbach, M., Olsen, J. V., & Mann, M. (2009). A practical guide to the MaxQuant computational platform for SILAC-based quantitative proteomics. Nature protocols, 4(5), 698–705. https://doi.org/10.1038/nprot.2009.36
- https://pubmed.ncbi.nlm.nih.gov/27809316/ - Tyanova, S., Temu, T., & Cox, J. (2016). The MaxQuant computational platform for mass spectrometry-based shotgun proteomics. Nature protocols, 11(12), 2301–2319. https://doi.org/10.1038/nprot.2016.136
- https://pubmed.ncbi.nlm.nih.gov/30104418/ - Ludwig, C., Gillet, L., Rosenberger, G., Amon, S., Collins, B. C., & Aebersold, R. (2018). Data-independent acquisition-based SWATH-MS for quantitative proteomics: a tutorial. Molecular systems biology, 14(8), e8126. https://doi.org/10.15252/msb.20178126
- https://www.annualreviews.org/doi/10.1146/annurev-biodatasci-080917-013516 - Sinitcyn, P., Rudolph, J. D., & Cox, J. (2018). Computational methods for understanding mass spectrometry–based shotgun proteomics data. Annual Review of Biomedical Data Science, 1, 207-234.

## File transfer

__Windows__ Users should download https://winscp.net/eng/index.php then connect to Wynton as below. Files can then be transferred from local computer or workstation. See more at https://wynton.ucsf.edu/hpc/about/specs.html#data-transfer-nodes.
<img width="40%" src="https://user-images.githubusercontent.com/5241605/92155851-e6439c00-eddc-11ea-9697-e3a318706542.png">

__Linux/OSX__ To be updated.

## Login

__Windows__ Users should download https://www.putty.org/. Even if you are on Windows 10 (which has `ssh` in `cmd`), use this as easier to deal with certificates, etc.

__Linux/OSX__ To be updated.

There are two Wynton login nodes, see https://wynton.ucsf.edu/hpc/about/specs.html#login-nodes. Setup PuTTY as below. Else follow example as in https://wynton.ucsf.edu/hpc/get-started/access-cluster.html#example.

<img width="40%" src="https://user-images.githubusercontent.com/5241605/92156176-7550b400-eddd-11ea-9bcf-4d902064d82b.png">

### MaxQuant parameters file and fasta

__Parameters__ In `parameters` folder there is a MaxQuant XML `mqpar.xml` that contains an example parameters file (generated by `maxquant -c mqpar.xml` on Wynton). In general, it is likely easiest to use the MaxQuant GUI to generate the XML file then edit the file paths to ones on Wynton.

__FASTA__ The _Mus musculus_ (Mouse) fasta can be found at <a href="https://www.uniprot.org/uniprot/?query=proteome:UP000000589+reviewed:yes">https://www.uniprot.org/uniprot/?query=proteome:UP000000589+reviewed:yes</a> then download as below:

<img width="40%" src="https://user-images.githubusercontent.com/5241605/92160137-71279500-ede3-11ea-827e-c7958c4976b1.png">4

## Setup Anaconda and MaxQuant

Copy both `bash` and `parameters` folders into a `scripts` or similar sub-directory in home Wynton folder.

In the terminal, enter the below. This will setup Anaconda, make an Anaconda environment for MaxQuant, and then install MaxQuant and its dependencies. If you run into trouble, enter the commands in the bash script one-by-one.

```bash
cd scripts/maxquant/bash
bash maxquantSetup.sh
```

## Running MaxQuant

Assuming you are still in the same directory as in the setup step, run MaxQuant as below. Remember to edit the `mqparPath` file in `runMaxQuant.sh` to the path for the MaxQuant XML parameters file you want to use.

```bash
bash submitJob.sh
watch qstat
```

Running `watch qstat` will allow continous monitoring of job status. If you look in the directory where `submitJob.sh` is located, there will be a file called `runMaxQuant.sh.o$jobID` where `$jobID` will match the Wynton scheduler job ID. Monitor this file to check the status of MaxQuant.

## MaxQuant analysis steps

In general, MaxQuant will conduct the below steps using the indocated number of cores, this is based off of a file with 16 `.RAW` files using 32 threads. As can be seen, there are certain bottlenecks where more Wynton cores may not speed up analysis with a fixed number of input files, this is still to be determined.

```
id   number of threads   job name
1    1                   Configuring
2    1                   Testing fasta files
3    16                  Testing raw files
4    16                  Feature detection
5    16                  Calculating peak properties
6    1                   Combining apl files for first search
7    1                   Preparing searches
8    32                  MS/MS first search
9    32                  Read search results for recalibration
10   16                  Mass recalibration
11   16                  MS/MS preparation for main search
12   1                   Combining apl files for main search
13   32                  MS/MS main search
14   1                   Preparing combined folder
15   16                  Calculating masses
16   1                   Correcting errors
17   16                  Reading search engine results
18   1                   Preparing reverse hits
19   16                  Finish search engine results
20   16                  Filter identifications (MS/MS)
21   1                   Applying FDR
22   16                  Assembling second peptide MS/MS
23   1                   Combining second peptide files
24   32                  Second peptide search
25   16                  Reading search engine results (SP)
26   16                  Finish search engine results (SP)
27   16                  Filtering identifications (SP)
28   1                   Applying FDR (SP)
29   16                  Re-quantification
30   16                  Reporter quantification
31   1                   Prepare protein assembly
32   16                  Assembling proteins
33   16                  Assembling unidentified peptides
34   1                   Finish protein assembly
35   16                  Updating identifications
36   16                  Estimating complexity
37   1                   Prepare writing tables
38   32                  Writing tables
39   1                   Finish writing tables
```